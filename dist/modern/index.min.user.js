// ==UserScript==
// @name           Userscripts Configurer
// @author         Oleg Valter <oleg.a.valter@gmail.com>
// @description    One script to configure them all
// @exclude        https://chat.meta.stackexchange.com/*
// @exclude        https://chat.stackexchange.com/*
// @exclude        https://stackexchange.com/*
// @grant          GM_getValue
// @grant          GM_setValue
// @grant          GM_deleteValue
// @grant          unsafeWindow
// @homepage       https://github.com/userscripters/userscripts-configurer#readme
// @match          https://stackoverflow.com/*
// @match          https://serverfault.com/*
// @match          https://superuser.com/*
// @match          https://*.stackexchange.com/*
// @match          https://askubuntu.com/*
// @match          https://stackapps.com/*
// @match          https://mathoverflow.net/*
// @match          https://pt.stackoverflow.com/*
// @match          https://ja.stackoverflow.com/*
// @match          https://ru.stackoverflow.com/*
// @match          https://es.stackoverflow.com/*
// @match          https://meta.stackoverflow.com/*
// @match          https://meta.serverfault.com/*
// @match          https://meta.superuser.com/*
// @match          https://meta.askubuntu.com/*
// @match          https://meta.mathoverflow.net/*
// @match          https://pt.meta.stackoverflow.com/*
// @match          https://ja.meta.stackoverflow.com/*
// @match          https://ru.meta.stackoverflow.com/*
// @match          https://es.meta.stackoverflow.com/*
// @namespace      userscripters
// @require        https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at         document-start
// @source         git+https://github.com/userscripters/userscripts-configurer.git
// @supportURL     https://github.com/userscripters/userscripts-configurer/issues
// @version        2.1.1
// ==/UserScript==

"use strict";window.addEventListener("load",async()=>{const v="userscript-configurer",e=window["Store"];if(!e)return void console.debug(`[${v}] missing UserScripters storage`);const i=e=>[...e.children].forEach(e=>e.remove());const a=(e,t,{classes:s=[],title:n,danger:a=!1,loading:i=!1,muted:r=!1,parent:o,primary:d=!1,type:l="filled"}={})=>{const c=document.createElement("button"),u=(c.id=e,c.textContent=t,c.classList.add("s-btn","s-btn__"+l,...s),c.setAttribute("role","button"),c.setAttribute("aria-label",n||t),c)["classList"];return a&&u.add("s-btn__danger"),r&&u.add("s-btn__muted"),d&&u.add("s-btn__primary"),i&&u.add("is-loading"),n&&(c.title=n),null!=o&&o.append(c),c},f=(e,t={})=>{const{classes:s=[],description:n="",parent:a,placeholder:i="",title:r="",value:o=""}=t,d=document.createElement("div"),l=(d.classList.add("d-flex","gs4","gsy","fd-column",...s),document.createElement("div")),c=(l.classList.add("d-flex","ps-relative"),document.createElement("input"));if(c.classList.add("s-input"),c.id=e,c.type="text",c.placeholder=i,c.value=o,l.append(c),d.append(l),r){const u=document.createElement("div"),p=(u.classList.add("flex--item"),document.createElement("label"));if(p.classList.add("d-block","s-label"),p.htmlFor=e,p.textContent=r,n){const m=document.createElement("p");m.classList.add("s-description","mt2"),m.textContent=n,p.append(m)}return u.append(p),d.prepend(u),[d,c,p]}return null!==a&&void 0!==a&&a.append(d),[d,c]},x=(e,t)=>{const{items:s=[],classes:n=[]}=t,a=document.createElement("fieldset");a.classList.add(...n),a.id=e;t=s.map(e=>{var{disabled:e=!1,id:t,label:s,name:n,selected:a=!1,value:i=""}=e;const r=document.createElement("div"),o=r["classList"],d=(o.add("d-flex","gs8"),e&&o.add("is-disabled"),document.createElement("div")),l=(d.classList.add("flex--item"),document.createElement("input")),c=(l.classList.add("s-checkbox"),l.disabled=e,l.id=t||n,l.name=n,l.type="checkbox",l.checked=a,l.value=i,document.createElement("label"));return c.classList.add("flex--item","s-label","fw-normal"),c.htmlFor=t||n,c.textContent=s,d.append(l),r.append(d,c),r});return a.append(...t),[a]},w=(e,t)=>{const{classes:s=[],description:n="",disabled:a=!1,items:i=[],title:r="",value:o=""}=t,d=document.createElement("div");if(d.classList.add("d-flex","gs4","gsy","fd-column",...s),r){const u=document.createElement("label");if(u.classList.add("d-block","s-label"),u.htmlFor=e,u.textContent=r,n){const p=document.createElement("p");p.classList.add("s-description","mt2"),p.textContent=n,u.append(p)}d.append(u)}const l=document.createElement("div"),c=(l.classList.add("flex--item","s-select"),document.createElement("select"));c.id=e,c.disabled=a;t=i.map(e=>{var{disabled:e=!1,label:t,selected:s=!1,value:n=""}=e;const a=document.createElement("option");return a.selected=s,a.value=n,a.textContent=t,a.disabled=e,a});return c.append(...t),c.value=o,l.append(c),d.append(l),[d,c]},E=(e,t)=>{var{classes:t=[],description:s,disabled:n=!1,direction:a="right",selected:i=!1,title:r}=t;const o=document.createElement("div"),d=(o.classList.add("d-flex","ai-center","gs8",...t),o.classList.toggle("disabled-area",n),document.createElement("label"));if(d.classList.add("flex--item","s-label"),d.htmlFor=e,d.textContent=r,s){const p=document.createElement("p");p.classList.add("s-description","mt2"),p.textContent=s,d.append(p)}const l=document.createElement("div"),c=(l.classList.add("flex--item","s-toggle-switch"),document.createElement("input")),u=(c.type="checkbox",c.id=e,c.checked=i,document.createElement("div"));return u.classList.add("s-toggle-switch--indicator"),l.append(c,u),o.append(..."right"===a?[d,l]:[l,d]),[o,c]},r=(e,t,s={})=>{const{buttons:n=[],classes:a=[],important:i=!1,msgClasses:r=[],parent:o,type:d="none"}=s,l=document.createElement("div"),c=(l.classList.add("s-toast",...a),l.setAttribute("aria-hidden","true"),l.setAttribute("role","alertdialog"),l.setAttribute("aria-labelledby","notice-message"),l.id=e,document.createElement("aside")),u=(c.classList.add("s-notice","p8","pl16"),"none"!==d&&c.classList.add("s-notice__"+d),i&&c.classList.add("s-notice__important"),document.createElement("div")),p=(u.classList.add("d-flex","gs16","gsx","ai-center","jc-space-between",...r),document.createElement("div")),m=(p.classList.add("flex--item"),p.textContent=t,document.createElement("div")),h=(m.classList.add("d-flex"),document.createElement("button"));h.type="button",h.classList.add("s-btn","s-notice--btn"),h.setAttribute("aria-label","Dismiss"),n.push(h);var[s]=((e,t,s={})=>{const{classes:n=[],width:a=14,height:i=a}=s;s="http://www.w3.org/2000/svg";const r=document.createElementNS(s,"svg"),o=(r.classList.add("svg-icon",e,...n),r.setAttribute("width",a.toString()),r.setAttribute("height",i.toString()),r.setAttribute("viewBox",`0 0 ${a} `+i),r.setAttribute("aria-hidden","true"),document.createElementNS(s,"path"));return o.setAttribute("d",t),r.append(o),[r,o]})("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z");return h.append(s),m.append(...n),u.append(p,m),c.append(u),l.append(c),o&&o.append(l),l},o=(e,t)=>{const s="string"==typeof e?document.querySelector(e):e;if(!s)throw new ReferenceError("missing toast: "+e);const n="true"!==(null===s||void 0===s?void 0:s.getAttribute("aria-hidden"));return s.setAttribute("aria-hidden",(void 0!==t?!t:n).toString()),s},d=(e,t)=>{const n=o(e,!0);t&&setTimeout(()=>{{var e=n,t=void 0;const s=o(e,!1);t&&setTimeout(()=>d(s),1e3*t)}},1e3*t)},L=e=>e instanceof HTMLInputElement&&e.checked,t=e=>e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase(),y=e=>e.split(/[-.]/).map(t).join(" "),A=(e,t,s)=>{const{width:n=1,height:a=1,color:i="black"}=s;const r=document.createElementNS("http://www.w3.org/2000/svg","rect");return r.setAttribute("fill",i),r.setAttribute("height",a.toFixed(0)),r.setAttribute("width",n.toFixed(0)),r.setAttribute("x",t.toFixed(0)),r.setAttribute("y",e.toFixed(0)),r},C=(e,t,s)=>{const{classes:n=[],color:a="black",halign:i="start",size:r=12,text:o="",valign:d="top",weight:l="normal"}=s;var s="number"==typeof r?r.toFixed(0)+"px":r,c="number"==typeof l?l.toFixed(0):l,u="middle"===d?"central":"text-"+d,t="number"==typeof t?t.toFixed(0):t,e="number"==typeof e?e.toFixed(0):e;const p=document.createElementNS("http://www.w3.org/2000/svg","text");return p.classList.add(...n),p.setAttribute("fill",a),p.setAttribute("dominant-baseline",u),p.setAttribute("font-size",s),p.setAttribute("font-weight",c),p.setAttribute("text-anchor",i),p.setAttribute("x",t),p.setAttribute("y",e),p.textContent=o,p},l=(e,t,s)=>{var n={height:9,width:9},a=A(0,0,{color:"#66d9ef",...n}),i=A(0,9,{color:"#f92342",...n}),r=A(9,9,{color:"#99e227",...n}),n=A(9,0,{color:"#8d81ff",...n}),o={family:"Helvetica, Arial, sans-serif",halign:"middle",size:5,valign:"middle",weight:600},d=C("25%","25%",{color:"#f92342",text:"U",...o}),l=C("25%","75%",{color:"#66d9ef",text:"S",...o}),c=C("75%","25%",{color:"#99e227",text:"E",...o}),o=C("75%","75%",{color:"#8d81ff",text:"R",...o});{const{classes:u=[],iconContent:p=[],linkClickable:m=!0,parent:h}=s={...s,linkClickable:!1,iconContent:[a,i,r,n,d,l,c,o]},b=document.createElement("li"),g=(b.classList.toggle("c-pointer",!m),b.id=e,b.setAttribute("role","none"),document.createElement(m?"a":"div")),v=(g.classList.add("s-topbar--item",...u),g.title=t,document.createElementNS("http://www.w3.org/2000/svg","svg"));return v.classList.add("svg-icon","native"),v.setAttribute("height","18"),v.setAttribute("width","18"),v.setAttribute("viewBox","0 0 18 18"),v.append(...p),g.append(v),b.append(g),null!==h&&void 0!==h&&h.append(b),b}};class c{constructor(e,t,s){this.script=e,this.name=t,this.config=s}async shouldDisable(){const{config:e,script:t}=this;var s,n;for([s,n]of Object.entries(e.disabledWhen||{}))if(t.get(s)){var a=await t.load(s,e.def);if(n===a)return!0}return!1}async render(){const{config:e,name:a,script:i}=this,t={toggle:E,text:f,select:w,checkbox:x},{desc:s,def:n,disabledWhen:r,items:o=[],title:d="",type:l="text",...c}=e,u=await i.load(a,n),p=Array.isArray(u);var m="boolean"==typeof u;const h=v+`-${i.name}-`+a,b={...c,classes:[v+"-userscript-option","mb16"],disabled:await this.shouldDisable(),items:o.map((e,t)=>{const{value:s,name:n,selected:a,...i}=e;return{...i,name:n||h+"-item-"+t,selected:p&&void 0!==s?u.includes(s):a,value:s}}),description:s,title:d||y(a)},[g]=(p||m||(b.value=u),"toggle"===l&&(b.selected=!!u),t[l](h,b));return(this.container=g).addEventListener("change",async({currentTarget:e,target:t})=>{var s,n;s=t,[HTMLInputElement,HTMLSelectElement].some(e=>s instanceof e)&&(n=await i.load(a),e=e instanceof HTMLFieldSetElement?{value:[...e.elements].filter(L).map(e=>e.value)}:t,t="toggle"===l&&e instanceof HTMLInputElement?e.checked:e.value,await i.save(a,t),e=new CustomEvent(v+"-change",{bubbles:!0,detail:{name:a,oldValue:n,script:i.name,value:t}}),null!=(n=i.container)&&n.dispatchEvent(e))}),g}}class s extends e.default{constructor(e,t){super(e,t),this.name=e,this.storage=t,this.opts=new Map}get(e){const t=this["opts"];return t.get(e)}has(e){const t=this["opts"];return t.has(e)}option(e,t){return this.opts.set(e,new c(this,e,t)),this.render(),this}options(e,t){const s=this["opts"],n=t||{};return Object.entries(e).forEach(([e,t])=>{s.set(e,new c(this,e,{...n,...t}))}),this.render(),this}async render(){var{name:e,opts:t}=this;const s=this.container||(this.container=document.createElement("div")),n=(s.classList.add(v+"-userscript","d-flex","fd-column","mb24"),document.createElement("h2"));n.textContent=y(e);e=[...t].map(([,e])=>e.render()),e.length||n.classList.add("mb8"),this.toast||(this.toast=r(v+"-toast",`Updated ${v} config`,{classes:[v+"-userscript-toast","wmn3","r0","jc-end"],type:"success"})),s.addEventListener(v+"-change",()=>{var e=this["toast"];e&&d(e,1),this.render()}),t=await Promise.all(e);if(i(s),s.append(this.toast,n,...t),!t.length){const a=document.createElement("div");a.textContent="No configuration options available",s.append(a)}return s}}class n{constructor(e){this.text=e,this.position="sidebar"}get footerParent(){return document.querySelector(".site-footer--categories-nav ul")}get navParent(){return document.querySelector(".js-top-bar .s-topbar--content")}get sidebarParent(){return document.body}get parent(){var e=this["position"];return this[e+"Parent"]}setPosition(e){return this.position=e,this}toggle(){var e;return null!=(e=this.container)&&e.click(),this}async render(){const e={footer:a,nav:l,sidebar:a};var{parent:t,position:s,text:n}=this;return this.container||(this.container=e[s](v+"-modal-controller",n,{parent:t,type:"outlined",muted:!0,classes:[...{footer:["s-btn__link"],sidebar:["ps-fixed","r0","t128"]}[s]||[],"bar0"]}))}}const u=unsafeWindow.UserScripters||(unsafeWindow.UserScripters={}),p=u.Userscripts||(u.Userscripts={});var m=e.locateStorage();const h=new class{constructor(e){this.storage=e,this.controller=new n("UserScripters"),this.scripts=new Map}async render(){var e=[...this.scripts].map(([,e])=>e.render());const t=this.get(v),s=this["controller"];var n=await(null===t||void 0===t?void 0:t.load("button-position"))||"sidebar",n=(s.setPosition(n),await s.render());this.modal||(this.modal=((e,t,s)=>{const{classes:n=[],content:a=[],contentClasses:i=[],controllerClasses:r,expanded:o=!1,parent:d}=s,l=document.createElement("div"),c=(l.classList.add("s-expandable",...n),l.id=e,o&&l.classList.add("is-expanded"),document.createElement("div")),u=(c.classList.add("s-expandable--content",...i),c.append(...a),t)["dataset"];return u.controller="s-expandable-control",r&&(u.sExpandableControlToggleClass=r.join(" ")),t.setAttribute("aria-controls",e),t.setAttribute("aria-expanded",JSON.stringify(o)),l.append(c),null!==d&&void 0!==d&&d.append(l),l})(v+"-modal",n,{classes:["ps-fixed","r0","z-modal",v+"-modal"],contentClasses:["ba","bar-lg","bc-black-075","bg-white","p16","wmn3"],expanded:!1,parent:document.body}));const a=this.modal.querySelector(".s-expandable--content");return a?(n=await Promise.all(e),i(a),a.append(...n)):console.debug(`[${v}] missing modal content element`),this}has(e){const t=this["scripts"];return t.has(e)}hide(){var e;return null!=(e=this.modal)&&e.classList.contains("is-expanded")&&null!=(e=this.controller)&&e.toggle(),this}get(e){const t=this["scripts"];return t.get(e)}register(e,t){t=new s(e,t||this.storage);return this.scripts.set(e,t),this.render(),t}show(){var e;return null!=(e=this.modal)&&e.classList.contains("is-expanded")||null!=(e=this.controller)&&e.toggle(),this}unregister(e){const t=this["scripts"];var s=t.get(e);return s&&(t.delete(e),this.render()),s}}(m);p.Configurer||(p.Configurer=h);{var b=document.createElement("style");document.head.append(b);const g=b["sheet"];if(g){const S=[`.${v}-modal {
                top: 20vh;
            }`,`.${v}-modal > .s-expandable--content {
                max-height: 60vh;
                overflow-y: auto;
            }`,`.${v}-modal > .s-expandable--content:empty::after {
                content: 'No userscripts to configure';
            }`,`.${v}-userscript:last-child {
                margin-bottom: var(--su2) !important;
            }`,`.${v}-userscript-toast {
                top: 20vh;
                left: unset;
            }`,`.${v}-userscript-option:last-child {
                margin-bottom: 0 !important;
            }`];S.forEach(e=>g.insertRule(e))}}h.register(v,m).options({"button-position":{def:"sidebar",desc:'Changes where the "UserScripters" button appears in the UI',items:[{label:"Footer",value:"footer"},{label:"Navigation",value:"nav"},{label:"Sidebar",value:"sidebar"}],title:"Button Placement",type:"select"}}),await h.render(),unsafeWindow.dispatchEvent(new CustomEvent(v+"-load"))},{once:!0});