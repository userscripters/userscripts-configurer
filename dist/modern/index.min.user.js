// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     One script to configure them all
// @exclude         https://chat.meta.stackexchange.com/*
// @exclude         https://chat.stackexchange.com/*
// @exclude         https://stackexchange.com/*
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @grant           unsafeWindow
// @homepage        https://github.com/userscripters/userscripts-configurer#readme
// @match           https://*.stackexchange.com/*
// @match           https://askubuntu.com/*
// @match           https://es.meta.stackoverflow.com/*
// @match           https://es.stackoverflow.com/*
// @match           https://ja.meta.stackoverflow.com/*
// @match           https://ja.stackoverflow.com/*
// @match           https://mathoverflow.net/*
// @match           https://meta.askubuntu.com/*
// @match           https://meta.mathoverflow.net/*
// @match           https://meta.serverfault.com/*
// @match           https://meta.stackoverflow.com/*
// @match           https://meta.superuser.com/*
// @match           https://pt.meta.stackoverflow.com/*
// @match           https://pt.stackoverflow.com/*
// @match           https://ru.meta.stackoverflow.com/*
// @match           https://ru.stackoverflow.com/*
// @match           https://serverfault.com/*
// @match           https://stackapps.com/*
// @match           https://stackoverflow.com/*
// @match           https://superuser.com/*
// @name            Userscripts Configurer
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/userscripts-configurer.git
// @supportURL      https://github.com/userscripters/userscripts-configurer/issues
// @version         1.1.2
// ==/UserScript==

"use strict";window.addEventListener("load",async()=>{const v="userscript-configurer",e=window["Store"];if(!e)return void console.debug(`[${v}] missing UserScripters storage`);const i=e=>[...e.children].forEach(e=>e.remove());const g=(e,t={})=>{const{classes:s=[],description:n="",parent:a,placeholder:i="",title:d="",value:r=""}=t,c=document.createElement("div"),l=(c.classList.add("d-flex","gs4","gsy","fd-column",...s),document.createElement("div")),o=(l.classList.add("d-flex","ps-relative"),document.createElement("input"));if(o.classList.add("s-input"),o.id=e,o.type="text",o.placeholder=i,o.value=r,l.append(o),c.append(l),d){const p=document.createElement("div"),u=(p.classList.add("flex--item"),document.createElement("label"));if(u.classList.add("d-block","s-label"),u.htmlFor=e,u.textContent=d,n){const m=document.createElement("p");m.classList.add("s-description","mt2"),m.textContent=n,u.append(m)}return p.append(u),c.prepend(p),[c,o,u]}return null!==a&&void 0!==a&&a.append(c),[c,o]},f=(e,t)=>{const{items:s=[],classes:n=[]}=t,a=document.createElement("fieldset");a.classList.add(...n),a.id=e;t=s.map(e=>{var{disabled:e=!1,id:t,label:s,name:n,selected:a=!1,value:i=""}=e;const d=document.createElement("div"),r=d["classList"],c=(r.add("d-flex","gs8"),e&&r.add("is-disabled"),document.createElement("div")),l=(c.classList.add("flex--item"),document.createElement("input")),o=(l.classList.add("s-checkbox"),l.disabled=e,l.id=t||n,l.name=n,l.type="checkbox",l.checked=a,l.value=i,document.createElement("label"));return o.classList.add("flex--item","s-label","fw-normal"),o.htmlFor=t||n,o.textContent=s,c.append(l),d.append(c,o),d});return a.append(...t),[a]},E=(e,t)=>{const{classes:s=[],description:n="",disabled:a=!1,items:i=[],title:d="",value:r=""}=t,c=document.createElement("div");if(c.classList.add("d-flex","gs4","gsy","fd-column",...s),d){const p=document.createElement("label");if(p.classList.add("d-block","s-label"),p.htmlFor=e,p.textContent=d,n){const u=document.createElement("p");u.classList.add("s-description","mt2"),u.textContent=n,p.append(u)}c.append(p)}const l=document.createElement("div"),o=(l.classList.add("flex--item","s-select"),document.createElement("select"));o.id=e,o.disabled=a;t=i.map(e=>{var{disabled:e=!1,label:t,selected:s=!1,value:n=""}=e;const a=document.createElement("option");return a.selected=s,a.value=n,a.textContent=t,a.disabled=e,a});return o.append(...t),o.value=r,l.append(o),c.append(l),[c,o]},x=(e,t)=>{var{classes:t=[],direction:s="right",selected:n=!1,title:a}=t;const i=document.createElement("div"),d=(i.classList.add("d-flex","ai-center","gs8",...t),document.createElement("label")),r=(d.classList.add("flex--item","s-label"),d.htmlFor=e,d.textContent=a,document.createElement("div")),c=(r.classList.add("flex--item","s-toggle-switch"),document.createElement("input")),l=(c.type="checkbox",c.id=e,c.checked=n,document.createElement("div"));return l.classList.add("s-toggle-switch--indicator"),r.append(c,l),i.append(..."right"===s?[d,r]:[r,d]),[i,c]},d=(e,t,s={})=>{const{buttons:n=[],classes:a=[],important:i=!1,msgClasses:d=[],parent:r,type:c="none"}=s,l=document.createElement("div"),o=(l.classList.add("s-toast",...a),l.setAttribute("aria-hidden","true"),l.setAttribute("role","alertdialog"),l.setAttribute("aria-labelledby","notice-message"),l.id=e,document.createElement("aside")),p=(o.classList.add("s-notice","p8","pl16"),"none"!==c&&o.classList.add("s-notice__"+c),i&&o.classList.add("s-notice__important"),document.createElement("div")),u=(p.classList.add("d-flex","gs16","gsx","ai-center","jc-space-between",...d),document.createElement("div")),m=(u.classList.add("flex--item"),u.textContent=t,document.createElement("div")),h=(m.classList.add("d-flex"),document.createElement("button"));h.type="button",h.classList.add("s-btn","s-notice--btn"),h.setAttribute("aria-label","Dismiss"),n.push(h);var[s]=((e,t,s={})=>{const{classes:n=[],width:a=14,height:i=a}=s;s="http://www.w3.org/2000/svg";const d=document.createElementNS(s,"svg"),r=(d.classList.add("svg-icon",e,...n),d.setAttribute("width",a.toString()),d.setAttribute("height",i.toString()),d.setAttribute("viewBox",`0 0 ${a} `+i),d.setAttribute("aria-hidden","true"),document.createElementNS(s,"path"));return r.setAttribute("d",t),d.append(r),[d,r]})("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z");return h.append(s),m.append(...n),p.append(u,m),o.append(p),l.append(o),r&&r.append(l),l},a=(e,t)=>{const s="string"==typeof e?document.querySelector(e):e;if(!s)throw new ReferenceError("missing toast: "+e);const n="true"!==(null===s||void 0===s?void 0:s.getAttribute("aria-hidden"));return s.setAttribute("aria-hidden",(void 0!==t?!t:n).toString()),s},r=(e,t)=>{const n=a(e,!0);t&&setTimeout(()=>{{var e=n,t=void 0;const s=a(e,!1);return void(t&&setTimeout(()=>r(s),1e3*t))}},1e3*t)},L=e=>e instanceof HTMLInputElement&&e.checked,t=e=>e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase(),w=e=>e.split(/[-.]/).map(t).join(" ");class s{constructor(e,t){this.script=e,this.config=t}async render(){const{config:e,script:n}=this,t={toggle:x,text:g,select:E,checkbox:f},{desc:s,def:a,name:i,items:d=[],title:r="",type:c="text",...l}=e,o=await n.load(i,a),p=Array.isArray(o);var u="boolean"==typeof o;const m=v+`-${n.name}-`+i,h={...l,classes:[v+"-userscript-option","mb16"],items:d.map((e,t)=>{const{value:s,name:n,selected:a,...i}=e;return{...i,name:n||m+"-item-"+t,selected:p&&void 0!==s?o.includes(s):a,value:s}}),description:s,title:r||w(i)},[b]=(p||u||(h.value=o),"toggle"===c&&(h.selected=!!o),t[c](m,h));return(this.container=b).addEventListener("change",async({currentTarget:e,target:t})=>{var s;s=t,[HTMLInputElement,HTMLSelectElement].some(e=>s instanceof e)&&(e=e instanceof HTMLFieldSetElement?{value:[...e.elements].filter(L).map(e=>e.value)}:t,t="toggle"===c&&e instanceof HTMLInputElement?e.checked:e.value,await n.save(i,t),null!=(e=n.container)&&e.dispatchEvent(new CustomEvent(v+"-success",{bubbles:!0,detail:{name:i,script:v,value:t}})))}),b}}class n extends(null===e||void 0===e?void 0:e.default){constructor(e,t){super(e,t),this.name=e,this.storage=t,this.options=new Map}has(e){const t=this["options"];return t.has(e)}option(e,t){return this.options.set(e,new s(this,{name:e,...t})),this.render(),this}async render(){var{name:e,options:t}=this;const s=this.container||(this.container=document.createElement("div")),n=(s.classList.add(v+"-userscript","d-flex","fd-column","mb24"),document.createElement("h2"));n.textContent=w(e);e=[...t].map(([,e])=>e.render()),e.length||n.classList.add("mb8"),this.toast||(this.toast=d(v+"-toast",`Updated ${v} config`,{classes:[v+"-userscript-toast","wmn3","r0","jc-end"],type:"success"})),s.addEventListener(v+"-success",()=>{var e=this["toast"];e&&r(e,1)}),t=await Promise.all(e);if(i(s),s.append(this.toast,n,...t),!t.length){const a=document.createElement("div");a.textContent="No configuration options available",s.append(a)}return s}}const c=unsafeWindow.UserScripters||(unsafeWindow.UserScripters={}),l=c.Userscripts||(c.Userscripts={}),o=new class{constructor(e){this.storage=e,this.scripts=new Map}async render(){var e={parent:document.body},t=["ps-fixed","r0"],s=[...this.scripts].map(([,e])=>e.render());this.controller||(this.controller=((e,t,{classes:s=[],title:n,danger:a=!1,loading:i=!1,muted:d=!1,parent:r,primary:c=!1,type:l="filled"})=>{const o=document.createElement("button"),p=(o.id=e,o.textContent=t,o.classList.add("s-btn","s-btn__"+l,...s),o.setAttribute("role","button"),o.setAttribute("aria-label",n||t),o)["classList"];return a&&p.add("s-btn__danger"),d&&p.add("s-btn__muted"),c&&p.add("s-btn__primary"),i&&p.add("is-loading"),n&&(o.title=n),null!=r&&r.append(o),o})(v+"-modal-controller","UserScripters",{...e,type:"outlined",muted:!0,classes:[...t,"bar0","t128"]})),this.modal||(this.modal=((e,t,s)=>{const{classes:n=[],content:a=[],contentClasses:i=[],controllerClasses:d,expanded:r=!1,parent:c}=s,l=document.createElement("div"),o=(l.classList.add("s-expandable",...n),l.id=e,r&&l.classList.add("is-expanded"),document.createElement("div")),p=(o.classList.add("s-expandable--content",...i),o.append(...a),t)["dataset"];return p.controller="s-expandable-control",d&&(p.sExpandableControlToggleClass=d.join(" ")),t.setAttribute("aria-controls",e),t.setAttribute("aria-expanded",JSON.stringify(r)),l.append(o),null!==c&&void 0!==c&&c.append(l),l})(v+"-modal",this.controller,{...e,classes:[...t,"z-modal",v+"-modal"],contentClasses:["ba","bar-lg","bc-black-075","bg-white","p16","wmn3"],expanded:!1}));const n=this.modal.querySelector(".s-expandable--content");if(!n)return console.debug(`[${v}] missing modal content element`),this;e=await Promise.all(s);return i(n),n.append(...e),this}has(e){const t=this["scripts"];return t.has(e)}hide(){var e;return null!=(e=this.modal)&&e.classList.contains("is-expanded")&&null!=(e=this.controller)&&e.click(),this}get(e){const t=this["scripts"];return t.get(e)}register(e){var t=this["storage"],t=new n(e,t);return this.scripts.set(e,t),this.render(),t}show(){var e;return null!=(e=this.modal)&&e.classList.contains("is-expanded")||null!=(e=this.controller)&&e.click(),this}unregister(e){const t=this["scripts"];var s=t.get(e);return s&&(t.delete(e),this.render()),s}}(e.locateStorage());l.Configurer||(l.Configurer=o);{var p=document.createElement("style");document.head.append(p);const u=p["sheet"];if(u){const m=[`.${v}-modal {
                top: 20vh;
            }`,`.${v}-modal > .s-expandable--content:empty::after {
                content: 'No userscripts to configure';
            }`,`.${v}-userscript:last-child {
                margin-bottom: var(--su2) !important;
            }`,`.${v}-userscript-toast {
                top: 20vh;
                left: unset;
            }`,`.${v}-userscript-option:last-child {
                margin-bottom: 0 !important;
            }`];m.forEach(e=>u.insertRule(e))}}await o.render(),unsafeWindow.dispatchEvent(new CustomEvent(v+"-load"))},{once:!0});